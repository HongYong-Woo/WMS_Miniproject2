<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.top.effitopia.mapper.WarehouseMapper">
    <resultMap id="warehouse" type="Warehouse">
        <id property="id" column="warehouse_id"/>
        <result property="code" column="warehouse_code"/>
        <result property="name" column="warehouse_name"/>
        <result property="phone" column="warehouse_phone"/>
        <result property="zipCode" column="warehouse_zip_code"/>
        <result property="roadName" column="warehouse_road_name"/>
        <result property="lotNumber" column="warehouse_lot_number"/>
        <result property="detailAddress" column="warehouse_detail_address"/>
        <result property="width" column="warehouse_width"/>
        <result property="length" column="warehouse_length"/>
        <result property="height" column="warehouse_height"/>
        <result property="capacity" column="warehouse_capacity"/>
        <result property="latitude" column="warehouse_latitude"/>
        <result property="longitude" column="warehouse_longitude"/>
        <result property="regDate" column="reg_date"/>
        <result property="modDate" column="mod_date"/>
        <association property="warehouseType" javaType="WarehouseType">
            <id property="id" column="category_id"/>
            <result property="type" column="warehouse_type"/>
        </association>
        <association property="member" javaType="Member">
            <id property="id" column="member_id"/>
            <result property="username" column="username"/>
        </association>
    </resultMap>

    <resultMap id ="cell" type ="Cell">
        <id property="id" column="cell_id"/>
        <result property="code" column="cell_code"/>
        <result property="width" column="cell_width"/>
        <result property="length" column="cell_length"/>
        <result property="height" column="cell_height"/>
        <result property="capacity" column="cell_capacity"/>
        <association property="warehouse" javaType="Warehouse">
            <id property="id" column="warehouse_id"/>
        </association>
    </resultMap>

    <resultMap id ="warehouseType" type ="WarehouseType">
        <id property="id" column="category_id"/>
        <result property="type" column="warehouse_type"/>
    </resultMap>

    <select id="selectId" parameterType="Integer" resultMap="warehouse">
        select * from warehouse w
        join warehouse_category wc on w.category_id = wc.category_id
        where warehouse_id = #{id}
    </select>

    <select id="selectName" parameterType="String">
        select warehouse_name from warehouse
        where warehouse_name = #{name}
    </select>

    <insert id="insert" parameterType="Warehouse">
        INSERT INTO warehouse (member_id, category_id, warehouse_code, warehouse_name, warehouse_phone,
                               warehouse_zip_code, warehouse_road_name, warehouse_lot_number, warehouse_detail_address,
                               warehouse_width, warehouse_length, warehouse_height, warehouse_capacity,
                               warehouse_latitude, warehouse_longitude, reg_date)
        VALUES
            (#{member.id}, #{warehouseType.id}, #{code}, #{name}, #{phone},#{zipCode} ,#{roadName}, #{lotNumber}, NULL,
             #{width}, #{length}, #{height}, #{capacity}, #{latitude}, #{longitude}, NOW())
    </insert>

    <select id="selectCellList" parameterType="com.top.effitopia.dto.PageRequestDTO" resultMap="cell">
        select * from Cell where warehouse_id = #{searchCond} ORDER BY cell_id  DESC LIMIT #{skip}, #{size}
    </select>

    <select id="selectWarehouseList" parameterType="com.top.effitopia.dto.PageRequestDTO" resultMap="warehouse">
        select * from warehouse w
        join warehouse_category wc on w.category_id = wc.category_id
        ORDER BY warehouse_id
        DESC LIMIT #{skip}, #{size}
    </select>

    <update id="update" parameterType="warehouse">
        UPDATE warehouse
        SET member_id=#{member.id}, warehouse_name=#{name}, warehouse_phone=#{phone}, mod_date=NOW()
        WHERE warehouse_id=#{id}
    </update>

    <select id="getCount" resultType="int">
        select count(warehouse_id) from warehouse
    </select>

    <select id="getWarehouseUtilization" parameterType="int" resultType="double">
        SELECT sum(p.inbound_box_width * p.inbound_box_height * p.inbound_box_length * s.amount) / w.warehouse_capacity * 100.0 AS utilization
        FROM stock s, product p, warehouse w, cell c
        WHERE w.warehouse_id=#{warehouseId} AND s.product_id=p.product_id AND c.cell_id=s.cell_id AND c.warehouse_id=w.warehouse_id;
    </select>

    <select id = "selectAllType" resultMap="warehouseType">
        select * from warehouse_category
    </select>
</mapper>